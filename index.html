<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taipei Carousel</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            margin: 20px;
        }
        a {
            margin-right: 10px;
            font-size: 14px;
        }
        #flightButtons a {
            margin-right: 5px;
        }
        
        #footer {
            margin-top: 40px;
            text-align: center;
        }
        #footer img {
            margin-right: 10px;
            vertical-align: middle;
        }
        .lang-switch a {
            text-decoration: none;
            margin: 0 10px;
            font-size: 16px;
            color: inherit;
        }
        .no-color-link a {
            color: inherit;
            text-decoration: underline;
        }
        .footer-container {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            gap: 5px; /* æ§åˆ¶å…ƒç´ ä¹‹é–“çš„é–“è· */
        }
        .footer-text {
            margin: 0;
            line-height: 1.2; /* æ¸›å°‘è¡Œè· */
        }

        /* BR (EVA Airways) æŒ‰éˆ•æ¨£å¼ */
        .btn-br {
            background-color: #4b7d6b !important;
            color: white !important;
            border: none;
        }

        /* CI (China Airlines) æŒ‰éˆ•æ¨£å¼ */
        .btn-ci {
            background-color: #3e62ad !important;
            color: white !important;
            border: none;
        }

        /* åœæ­¢ hover è®Šè‰² */
        .btn-no-hover:hover {
            background-color: inherit;
            color: inherit;
        }

        /* BR (EVA Airways) è¡¨æ ¼æ¨™é¡Œæ¨£å¼ */
        .table-br {
            --bs-table-bg: #4b7d6b;  /* å®šç¾©èƒŒæ™¯è‰² */
            --bs-table-color: white;  /* å®šç¾©æ–‡å­—é¡è‰² */
        }

        /* CI (China Airlines) è¡¨æ ¼æ¨™é¡Œæ¨£å¼ */
        .table-ci {
            --bs-table-bg: #3e62ad;  /* å®šç¾©èƒŒæ™¯è‰² */
            --bs-table-color: white;  /* å®šç¾©æ–‡å­—é¡è‰² */
        }

        /* ä¿æŒ Bootstrap 5 table-light æ¨£å¼ */
        .table-light {
            --bs-table-bg: #f8f9fa; /* é»˜èªèƒŒæ™¯è‰² */
            --bs-table-color: #000;  /* é»˜èªæ–‡å­—é¡è‰² */
        }
    </style>
</head>
<body>

    <div class="container">
        <h1 id="title" class="text-center my-4"></h1>

        <!-- å‹•æ…‹ç”Ÿæˆçš„èˆªç©ºå…¬å¸æŒ‰éˆ• -->
        <div id="airlineButtons" class="d-flex justify-content-center flex-wrap mb-3"></div>

        <!-- å‹•æ…‹ç”Ÿæˆçš„èˆªç­è™ŸæŒ‰éˆ•å€åŸŸ -->
        <div id="flightButtons" class="d-flex justify-content-center flex-wrap"></div>

        <!-- çµæœè¼¸å‡º -->
        <div id="output">å°åŒ—è¿´è½‰å£½å¸ğŸ£</div>

        <!-- èªè¨€åˆ‡æ›æŒ‰éˆ•æ”¾åˆ°é é¢åº•éƒ¨ -->
        <div id="footer">
            <div class="lang-switch no-color-link text-muted d-flex justify-content-center mb-2">
                <a href="javascript:void(0);" onclick="changeLanguage('zh')">ğŸ‡¹ğŸ‡¼ ç¹é«”ä¸­æ–‡</a> |
                <a href="javascript:void(0);" onclick="changeLanguage('en')">ğŸ‡¬ğŸ‡§ English</a> |
                <a href="javascript:void(0);" onclick="changeLanguage('jp')">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</a>
            </div>

            <!-- è¨»è§£éƒ¨åˆ† -->
            <div class="footer-container">
                <div class="no-color-link footer-text text-muted">
                    Data source: <a href="https://www.taoyuan-airport.com/flight_arrival">Taoyuan International Airport</a>
                </div>
                <!-- é¡¯ç¤º API query parameter çš„æ—¥æœŸå’Œæ™‚é–“ç¯„åœ -->
                <div id="apiParams" class="footer-text text-muted"></div>
                <div class="footer-text">
                    Made by EVA Pilot with <span style="color: red;">â¤ï¸</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let flightData = [];  // å­˜å„²æ‰€æœ‰æ’ˆå–çš„èˆªç­è³‡æ–™
        let currentFilteredFlights = [];  // å­˜å„²ç•¶å‰éæ¿¾çš„èˆªç©ºå…¬å¸èˆªç­
        let currentLanguage = 'zh';  // é è¨­èªè¨€ç‚ºç¹é«”ä¸­æ–‡

        // å®šç¾©ç¿»è­¯å­—å…¸
        const translations = {
            "zh": {
                "title": "å°åŒ—è¿´è½‰å£½å¸ğŸ£",
                "noFlights": "æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„èˆªç­ã€‚",
                "noTimeRange": "ç„¡æ³•åŒ¹é…æ™‚é–“ç¯„åœ",
                "querySuccess": "è«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•ä»¥æŸ¥çœ‹èˆªç­è³‡æ–™ã€‚",
                "error": "æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚",
                "tableHeaders": {
                    "FlightNumber": "èˆªç­è™Ÿ",
                    "Departure": "å‡ºç™¼åœ°",
                    "Terminal": "èˆªå»ˆ",
                    "Gate": "ç™»æ©Ÿé–€",
                    "Carousel": "è¡Œæè½‰ç›¤"
                }
            },
            "en": {
                "title": "Taipei sushi-go-roundğŸ£",
                "noFlights": "No matching flights found.",
                "noTimeRange": "Cannot match the time range",
                "querySuccess": "Please click the buttons above to view flight data.",
                "error": "Query failed, please try again later.",
                "tableHeaders": {
                    "FlightNumber": "Flight Number",
                    "Departure": "Departure",
                    "Terminal": "Terminal",
                    "Gate": "Gate",
                    "Carousel": "Carousel"
                }
            },
            "jp": {
                "title": "å°åŒ—å›è»¢å¯¿å¸ğŸ£",
                "noFlights": "ä¸€è‡´ã™ã‚‹ãƒ•ãƒ©ã‚¤ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚",
                "noTimeRange": "æ™‚é–“ç¯„å›²ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚",
                "querySuccess": "ä¸Šè¨˜ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ãƒ©ã‚¤ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¦ãã ã•ã„ã€‚",
                "error": "ã‚¯ã‚¨ãƒªã«å¤±æ•—ã—ã¾ã—ãŸã€‚å¾Œã§ã‚‚ã†ä¸€åº¦ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚",
                "tableHeaders": {
                    "FlightNumber": "ãƒ•ãƒ©ã‚¤ãƒˆç•ªå·",
                    "Departure": "å‡ºç™ºåœ°",
                    "Terminal": "ã‚¿ãƒ¼ãƒŸãƒŠãƒ«",
                    "Gate": "ã‚²ãƒ¼ãƒˆ",
                    "Carousel": "è·ç‰©å›è»¢å°"
                }
            }
        };

        // æ›´æ–°é é¢ä¸Šçš„æ–‡å­—
        function updateLanguageText() {
            document.getElementById("title").innerText = translations[currentLanguage]["title"];
        }

        // è‡ªå‹•æª¢æ¸¬ä½¿ç”¨è€…ç€è¦½å™¨èªè¨€
        function detectLanguage() {
            const browserLang = navigator.language || navigator.userLanguage;
            if (browserLang.startsWith("zh")) {
                currentLanguage = 'zh';  // è¨­ç½®ç‚ºä¸­æ–‡
            } else if (browserLang.startsWith("ja")) {
                currentLanguage = 'jp';  // è¨­ç½®ç‚ºæ—¥æ–‡
            } else {
                currentLanguage = 'en';  // è¨­ç½®ç‚ºè‹±æ–‡
            }
            updateLanguageText();  // æ›´æ–°é é¢æ–‡å­—
            fetchData(); // æ ¹æ“šæª¢æ¸¬åˆ°çš„èªè¨€é‡æ–°è¼‰å…¥è³‡æ–™
            updateApiParams(); // æ›´æ–° API query parameters é¡¯ç¤º
        }

        // åˆ‡æ›èªè¨€
        function changeLanguage(lang) {
            currentLanguage = lang;
            updateLanguageText();  // æ›´æ–°é é¢æ–‡å­—
            fetchData();  // é‡æ–°ç™¼é€è«‹æ±‚
            updateApiParams();  // æ›´æ–° API query parameters é¡¯ç¤º
            // æ¸…ç©º flightButtons å€åŸŸ
            document.getElementById("flightButtons").innerHTML = ""; 
        }

        // Helper: å–å¾—ç•¶å‰çš„ UTC+8 æ—¥æœŸï¼Œæ ¼å¼ç‚º "YYYY/MM/DD"
        function getUTC8Date() {
            const nowUTC = new Date(new Date().toISOString());
            const utc8Time = new Date(nowUTC.getTime() + 8 * 60 * 60 * 1000); // è½‰æ›ç‚º UTC+8
            return utc8Time.toISOString().split('T')[0].replace(/-/g, '/'); // å°‡æ—¥æœŸä¸­çš„ "-" æ›¿æ›ç‚º "/"
        }

        // Helper: å–å¾—ç•¶å‰ UTC+8 æ™‚é–“ç¯„åœ
        function getCurrentTimeRangeInUTC8() {
            const nowUTC = new Date(new Date().toISOString()); 
            const utc8Time = new Date(nowUTC.getTime() + 8 * 60 * 60 * 1000); 
            const hours = utc8Time.getUTCHours();

            const timeRanges = [
                { start: "00:00", end: "01:59" },
                { start: "02:00", end: "05:59" },
                { start: "06:00", end: "07:59" },
                { start: "08:00", end: "09:59" },
                { start: "10:00", end: "11:59" },
                { start: "12:00", end: "13:59" },
                { start: "14:00", end: "15:59" },
                { start: "16:00", end: "17:59" },
                { start: "18:00", end: "19:59" },
                { start: "20:00", end: "21:59" },
                { start: "22:00", end: "23:59" }
            ];

            for (const range of timeRanges) {
                const [startHours] = range.start.split(":").map(Number);
                const [endHours] = range.end.split(":").map(Number);

                if (hours >= startHours && hours <= endHours) {
                    return range;
                }
            }
            return null;
        }

        // æ›´æ–° API query parameters é¡¯ç¤º
        function updateApiParams() {
            const date = getUTC8Date();
            const timeRange = getCurrentTimeRangeInUTC8();
            if (timeRange) {
                const apiParamsText = `Query date: ${date}, Time range: ${timeRange.start} - ${timeRange.end}`;
                document.getElementById("apiParams").innerText = apiParamsText;
            } else {
                document.getElementById("apiParams").innerText = "No time range available";
            }
        }

        // Fetch API è³‡æ–™
        function fetchData() {
            const currentRange = getCurrentTimeRangeInUTC8();

            if (currentRange) {
                const postData = {
                    "ODate": getUTC8Date(), // ç•¶å‰ UTC+8 æ—¥æœŸï¼Œæ ¼å¼ç‚º "YYYY/MM/DD"
                    "OTimeOpen": currentRange.start,
                    "OTimeClose": currentRange.end,
                    "BNO": null,
                    "AState": "A",
                    "language": currentLanguage === "zh" ? "ch" : currentLanguage, // æ ¹æ“šèªè¨€åˆ‡æ› API æŸ¥è©¢èªè¨€
                    "keyword": "" // å¯é¸é—œéµå­—ï¼Œé€™è£¡å·²ç¶“å»æ‰è¼¸å…¥æ¡†ï¼Œæ‰€ä»¥ä¿ç•™ç©ºå­—ä¸²
                };

                // ä½¿ç”¨ Fetch ç™¼é€è«‹æ±‚
                fetch("https://www.taoyuan-airport.com/api/api/flight/a_flight", {
                    body: JSON.stringify(postData),
                    cache: "default",
                    headers: {
                        "Accept": "application/json, text/plain, */*",
                        "Accept-Language": "en-US,en;q=0.9",
                        "Content-Type": "application/json",
                        // "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.6 Safari/605.1.15"
                    },
                    method: "POST",
                    mode: "cors",
                    redirect: "follow",
                    referrerPolicy: "strict-origin-when-cross-origin"
                })
                .then(response => response.json())
                .then(data => {
                    flightData = data.filter(flight => flight.ACode === 'CI' || flight.ACode === 'BR');  // é è¨­é¡¯ç¤º CI å’Œ BR çš„èˆªç­
                    generateAirlineLinks(flightData); // å‹•æ…‹ç”Ÿæˆèˆªç©ºå…¬å¸æŒ‰éˆ•
                    displayFlights(flightData); // é è¨­é¡¯ç¤ºå…¨éƒ¨ CI å’Œ BR çš„èˆªç­
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById("output").innerText = translations[currentLanguage]["error"];
                });
            } else {
                document.getElementById("output").innerText = translations[currentLanguage]["noTimeRange"];
            }
        }

        // æ ¹æ“š API è³‡æ–™å‹•æ…‹ç”Ÿæˆèˆªç©ºå…¬å¸æŒ‰éˆ• (æ”¹ç‚º <a>ï¼Œä¸¦åŠ ä¸Š logo)
        function generateAirlineLinks(flights) {
            let airlines = {};

            flights.forEach(flight => {
                if (!airlines[flight.ACode]) {
                    airlines[flight.ACode] = flight.AName + ` (${flight.ACode})`;
                }
            });

            let linksHTML = '';

            // ç¢ºä¿ BR (é•·æ¦®èˆªç©º) é¡¯ç¤ºåœ¨æœ€å‰é¢
            if (airlines['BR']) {
                const logoUrlBR = `https://www.taoyuan-airport.com/uploads/airlogo/BR.gif`;
                linksHTML += `
                    <a href="javascript:void(0);" onclick="filterFlights('BR')">
                        <img alt="" width="28" height="20" src="${logoUrlBR}">
                        ${airlines['BR']}
                    </a>`;
                delete airlines['BR'];  // é¡¯ç¤ºå¾Œå°‡å…¶å¾ airlines ä¸­ç§»é™¤ï¼Œä»¥é¿å…é‡è¤‡
            }

            // ç”Ÿæˆå…¶é¤˜èˆªç©ºå…¬å¸æŒ‰éˆ•
            for (let code in airlines) {
                const logoUrl = `https://www.taoyuan-airport.com/uploads/airlogo/${code}.gif`;
                linksHTML += `
                    <a href="javascript:void(0);" onclick="filterFlights('${code}')">
                        <img alt="" width="28" height="20" src="${logoUrl}">
                        ${airlines[code]}
                    </a>`;
            }

            document.getElementById('airlineButtons').innerHTML = linksHTML;
        }


        // æ ¹æ“š ACode éæ¿¾èˆªç­è³‡æ–™ä¸¦é¡¯ç¤ºçµæœåˆ°è¡¨æ ¼ï¼Œä¸¦ç”Ÿæˆèˆªç­è™ŸæŒ‰éˆ•
        function filterFlights(airlineCode) {
            currentFilteredFlights = flightData.filter(flight => flight.ACode === airlineCode);

            if (currentFilteredFlights.length === 0) {
                document.getElementById("output").innerText = translations[currentLanguage]["noFlights"];
                document.getElementById("flightButtons").innerHTML = ""; // æ¸…ç©ºèˆªç­è™ŸæŒ‰éˆ•
            } else {
                generateFlightNumberButtons(currentFilteredFlights);  // ç”Ÿæˆèˆªç­è™ŸæŒ‰éˆ•
                displayFlights(currentFilteredFlights, airlineCode);  // å‚³é airlineCode ä½œç‚º ACode åƒæ•¸
            }
        }


        // æ ¹æ“šå…·é«”çš„ FlightNo ç”Ÿæˆèˆªç­è™ŸæŒ‰éˆ•
        function generateFlightNumberButtons(flights) {
            let flightButtonContent = "";

            flights.forEach(flight => {
                let btnClass = flight.ACode === 'BR' ? 'btn-br' : 'btn-ci';
                flightButtonContent += `<a href="javascript:void(0);" class="btn ${btnClass} btn-no-hover m-1" onclick="filterFlightByNumber('${flight.FlightNo}', '${flight.ACode}')">${flight.FlightNo}</a>`;
            });

            document.getElementById("flightButtons").innerHTML = flightButtonContent;
        }



        // æ ¹æ“šå…·é«”çš„ FlightNo éæ¿¾èˆªç­
        function filterFlightByNumber(flightNumber, ACode) {
            const filteredFlight = currentFilteredFlights.filter(flight => flight.FlightNo === flightNumber);
            displayFlights(filteredFlight, ACode); // å‚³é ACode åƒæ•¸ä»¥ç¢ºä¿èƒŒæ™¯é¡è‰²æ­£ç¢ºæ‡‰ç”¨
        }

        // é¡¯ç¤ºèˆªç­è³‡æ–™åˆ°è¡¨æ ¼ï¼Œä¸¦åœ¨èˆªç­è™Ÿå‰åŠ ä¸Š logo
        function displayFlights(flights, ACode) {
            // ç¢ºå®šè¡¨æ ¼é ­éƒ¨çš„æ¨£å¼é¡æ ¹æ“šå‚³éé€²ä¾†çš„ ACode
            let airlineClass = 'table-light';  // é è¨­ç‚º table-light
            if (ACode === 'BR') {
                airlineClass = 'table-br';
            } else if (ACode === 'CI') {
                airlineClass = 'table-ci';
            }

            // ç›´æ¥åœ¨ thead ä¸­æ·»åŠ ç›¸åº”çš„ class
            let tableContent = `
            <table class="table table-sm table-striped table-borderless">
                <thead class="${airlineClass}">
                    <tr>
                        <th>${translations[currentLanguage]["tableHeaders"]["FlightNumber"]}</th>
                        <th>${translations[currentLanguage]["tableHeaders"]["Departure"]}</th>
                        <th>${translations[currentLanguage]["tableHeaders"]["Terminal"]}</th>
                        <th>${translations[currentLanguage]["tableHeaders"]["Gate"]}</th>
                        <th>${translations[currentLanguage]["tableHeaders"]["Carousel"]}</th>
                    </tr>
                </thead>
                <tbody>`;

            flights.forEach(flight => {
                const cityDisplay = currentLanguage === 'zh' 
                    ? `${flight.CityName}`
                    : `${flight.CityEname}`;

                const terminalDisplay = flight.BNO ? `T${flight.BNO}` : '';
                const logoUrl = `https://www.taoyuan-airport.com/uploads/airlogo/${flight.ACode}.gif`;

                tableContent += `
                    <tr>
                        <td>
                            <img alt="" width="28" height="20" src="${logoUrl}">
                            ${flight.ACode}${flight.FlightNo}
                        </td>
                        <td>${cityDisplay}</td>
                        <td>${terminalDisplay}</td>
                        <td>${flight.Gate}</td>
                        <td>${flight.StopCode}</td>
                    </tr>`;
            });

            tableContent += `</tbody></table>`;

            // å°‡è¡¨æ ¼å…§å®¹æ’å…¥åˆ° output å€åŸŸ
            document.getElementById("output").innerHTML = tableContent;
        }

        // é é¢åŠ è¼‰æ™‚ï¼Œæª¢æ¸¬èªè¨€ä¸¦è¼‰å…¥è³‡æ–™
        window.onload = function() {
            detectLanguage();  // è‡ªå‹•æª¢æ¸¬èªè¨€ä¸¦åˆå§‹åŒ–
        };
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
