<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taipei Carousel</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            margin: 20px;
        }
        a {
            margin-right: 10px;
            font-size: 14px;
        }
        #flightButtons a {
            margin-right: 5px;
        }
        
        #footer {
            margin-top: 40px;
            text-align: center;
        }
        #footer img {
            margin-right: 10px;
            vertical-align: middle;
        }
        .lang-switch a {
            text-decoration: none;
            margin: 0 10px;
            font-size: 16px;
            color: inherit;
        }
        .no-color-link a {
            color: inherit;
            text-decoration: underline;
        }
        .footer-container {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            gap: 5px; /* 控制元素之間的間距 */
        }
        .footer-text {
            margin: 0;
            line-height: 1.2; /* 減少行距 */
        }

        /* BR (EVA Airways) 按鈕樣式 */
        .btn-br {
            background-color: #4b7d6b !important;
            color: white !important;
            border: none;
        }

        /* CI (China Airlines) 按鈕樣式 */
        .btn-ci {
            background-color: #3e62ad !important;
            color: white !important;
            border: none;
        }

        /* 停止 hover 變色 */
        .btn-no-hover:hover {
            background-color: inherit;
            color: inherit;
        }

        /* BR (EVA Airways) 表格標題樣式 */
        .table-br {
            --bs-table-bg: #4b7d6b;  /* 定義背景色 */
            --bs-table-color: white;  /* 定義文字顏色 */
        }

        /* CI (China Airlines) 表格標題樣式 */
        .table-ci {
            --bs-table-bg: #3e62ad;  /* 定義背景色 */
            --bs-table-color: white;  /* 定義文字顏色 */
        }

        /* 保持 Bootstrap 5 table-light 樣式 */
        .table-light {
            --bs-table-bg: #f8f9fa; /* 默認背景色 */
            --bs-table-color: #000;  /* 默認文字顏色 */
        }
    </style>
</head>
<body>

    <div class="container">
        <h1 id="title" class="text-center my-4"></h1>

        <!-- 動態生成的航空公司按鈕 -->
        <div id="airlineButtons" class="d-flex justify-content-center flex-wrap mb-3"></div>

        <!-- 動態生成的航班號按鈕區域 -->
        <div id="flightButtons" class="d-flex justify-content-center flex-wrap"></div>

        <!-- 結果輸出 -->
        <div id="output">台北迴轉壽司🍣</div>

        <!-- 語言切換按鈕放到頁面底部 -->
        <div id="footer">
            <div class="lang-switch no-color-link text-muted d-flex justify-content-center mb-2">
                <a href="javascript:void(0);" onclick="changeLanguage('zh')">🇹🇼 繁體中文</a> |
                <a href="javascript:void(0);" onclick="changeLanguage('en')">🇬🇧 English</a> |
                <a href="javascript:void(0);" onclick="changeLanguage('jp')">🇯🇵 日本語</a>
            </div>

            <!-- 註解部分 -->
            <div class="footer-container">
                <div class="no-color-link footer-text text-muted">
                    Data source: <a href="https://www.taoyuan-airport.com/flight_arrival">Taoyuan International Airport</a>
                </div>
                <!-- 顯示 API query parameter 的日期和時間範圍 -->
                <div id="apiParams" class="footer-text text-muted"></div>
                <div class="footer-text">
                    Made by EVA Pilot with <span style="color: red;">❤️</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let flightData = [];  // 存儲所有撈取的航班資料
        let currentFilteredFlights = [];  // 存儲當前過濾的航空公司航班
        let currentLanguage = 'zh';  // 預設語言為繁體中文

        // 定義翻譯字典
        const translations = {
            "zh": {
                "title": "台北迴轉壽司🍣",
                "noFlights": "沒有找到符合條件的航班。",
                "noTimeRange": "無法匹配時間範圍",
                "querySuccess": "請點擊上方按鈕以查看航班資料。",
                "error": "查詢失敗，請稍後再試。",
                "tableHeaders": {
                    "FlightNumber": "航班號",
                    "Departure": "出發地",
                    "Terminal": "航廈",
                    "Gate": "登機門",
                    "Carousel": "行李轉盤"
                }
            },
            "en": {
                "title": "Taipei sushi-go-round🍣",
                "noFlights": "No matching flights found.",
                "noTimeRange": "Cannot match the time range",
                "querySuccess": "Please click the buttons above to view flight data.",
                "error": "Query failed, please try again later.",
                "tableHeaders": {
                    "FlightNumber": "Flight Number",
                    "Departure": "Departure",
                    "Terminal": "Terminal",
                    "Gate": "Gate",
                    "Carousel": "Carousel"
                }
            },
            "jp": {
                "title": "台北回転寿司🍣",
                "noFlights": "一致するフライトが見つかりません。",
                "noTimeRange": "時間範囲が一致しません。",
                "querySuccess": "上記のボタンをクリックしてフライトデータを表示してください。",
                "error": "クエリに失敗しました。後でもう一度やり直してください。",
                "tableHeaders": {
                    "FlightNumber": "フライト番号",
                    "Departure": "出発地",
                    "Terminal": "ターミナル",
                    "Gate": "ゲート",
                    "Carousel": "荷物回転台"
                }
            }
        };

        // 更新頁面上的文字
        function updateLanguageText() {
            document.getElementById("title").innerText = translations[currentLanguage]["title"];
        }

        // 自動檢測使用者瀏覽器語言
        function detectLanguage() {
            const browserLang = navigator.language || navigator.userLanguage;
            if (browserLang.startsWith("zh")) {
                currentLanguage = 'zh';  // 設置為中文
            } else if (browserLang.startsWith("ja")) {
                currentLanguage = 'jp';  // 設置為日文
            } else {
                currentLanguage = 'en';  // 設置為英文
            }
            updateLanguageText();  // 更新頁面文字
            fetchData(); // 根據檢測到的語言重新載入資料
            updateApiParams(); // 更新 API query parameters 顯示
        }

        // 切換語言
        function changeLanguage(lang) {
            currentLanguage = lang;
            updateLanguageText();  // 更新頁面文字
            fetchData();  // 重新發送請求
            updateApiParams();  // 更新 API query parameters 顯示
            // 清空 flightButtons 區域
            document.getElementById("flightButtons").innerHTML = ""; 
        }

        // Helper: 取得當前的 UTC+8 日期，格式為 "YYYY/MM/DD"
        function getUTC8Date() {
            const nowUTC = new Date(new Date().toISOString());
            const utc8Time = new Date(nowUTC.getTime() + 8 * 60 * 60 * 1000); // 轉換為 UTC+8
            return utc8Time.toISOString().split('T')[0].replace(/-/g, '/'); // 將日期中的 "-" 替換為 "/"
        }

        // Helper: 取得當前 UTC+8 時間範圍
        function getCurrentTimeRangeInUTC8() {
            const nowUTC = new Date(new Date().toISOString()); 
            const utc8Time = new Date(nowUTC.getTime() + 8 * 60 * 60 * 1000); 
            const hours = utc8Time.getUTCHours();

            const timeRanges = [
                { start: "00:00", end: "01:59" },
                { start: "02:00", end: "05:59" },
                { start: "06:00", end: "07:59" },
                { start: "08:00", end: "09:59" },
                { start: "10:00", end: "11:59" },
                { start: "12:00", end: "13:59" },
                { start: "14:00", end: "15:59" },
                { start: "16:00", end: "17:59" },
                { start: "18:00", end: "19:59" },
                { start: "20:00", end: "21:59" },
                { start: "22:00", end: "23:59" }
            ];

            for (const range of timeRanges) {
                const [startHours] = range.start.split(":").map(Number);
                const [endHours] = range.end.split(":").map(Number);

                if (hours >= startHours && hours <= endHours) {
                    return range;
                }
            }
            return null;
        }

        // 更新 API query parameters 顯示
        function updateApiParams() {
            const date = getUTC8Date();
            const timeRange = getCurrentTimeRangeInUTC8();
            if (timeRange) {
                const apiParamsText = `Query date: ${date}, Time range: ${timeRange.start} - ${timeRange.end}`;
                document.getElementById("apiParams").innerText = apiParamsText;
            } else {
                document.getElementById("apiParams").innerText = "No time range available";
            }
        }

        // Fetch API 資料
        function fetchData() {
            const currentRange = getCurrentTimeRangeInUTC8();

            if (currentRange) {
                const postData = {
                    "ODate": getUTC8Date(), // 當前 UTC+8 日期，格式為 "YYYY/MM/DD"
                    "OTimeOpen": currentRange.start,
                    "OTimeClose": currentRange.end,
                    "BNO": null,
                    "AState": "A",
                    "language": currentLanguage === "zh" ? "ch" : currentLanguage, // 根據語言切換 API 查詢語言
                    "keyword": "" // 可選關鍵字，這裡已經去掉輸入框，所以保留空字串
                };

                // 使用 Fetch 發送請求
                fetch("https://www.taoyuan-airport.com/api/api/flight/a_flight", {
                    body: JSON.stringify(postData),
                    cache: "default",
                    headers: {
                        "Accept": "application/json, text/plain, */*",
                        "Accept-Language": "en-US,en;q=0.9",
                        "Content-Type": "application/json",
                        // "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.6 Safari/605.1.15"
                    },
                    method: "POST",
                    mode: "cors",
                    redirect: "follow",
                    referrerPolicy: "strict-origin-when-cross-origin"
                })
                .then(response => response.json())
                .then(data => {
                    flightData = data.filter(flight => flight.ACode === 'CI' || flight.ACode === 'BR');  // 預設顯示 CI 和 BR 的航班
                    generateAirlineLinks(flightData); // 動態生成航空公司按鈕
                    displayFlights(flightData); // 預設顯示全部 CI 和 BR 的航班
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById("output").innerText = translations[currentLanguage]["error"];
                });
            } else {
                document.getElementById("output").innerText = translations[currentLanguage]["noTimeRange"];
            }
        }

        // 根據 API 資料動態生成航空公司按鈕 (改為 <a>，並加上 logo)
        function generateAirlineLinks(flights) {
            let airlines = {};

            flights.forEach(flight => {
                if (!airlines[flight.ACode]) {
                    airlines[flight.ACode] = flight.AName + ` (${flight.ACode})`;
                }
            });

            let linksHTML = '';

            // 確保 BR (長榮航空) 顯示在最前面
            if (airlines['BR']) {
                const logoUrlBR = `https://www.taoyuan-airport.com/uploads/airlogo/BR.gif`;
                linksHTML += `
                    <a href="javascript:void(0);" onclick="filterFlights('BR')">
                        <img alt="" width="28" height="20" src="${logoUrlBR}">
                        ${airlines['BR']}
                    </a>`;
                delete airlines['BR'];  // 顯示後將其從 airlines 中移除，以避免重複
            }

            // 生成其餘航空公司按鈕
            for (let code in airlines) {
                const logoUrl = `https://www.taoyuan-airport.com/uploads/airlogo/${code}.gif`;
                linksHTML += `
                    <a href="javascript:void(0);" onclick="filterFlights('${code}')">
                        <img alt="" width="28" height="20" src="${logoUrl}">
                        ${airlines[code]}
                    </a>`;
            }

            document.getElementById('airlineButtons').innerHTML = linksHTML;
        }


        // 根據 ACode 過濾航班資料並顯示結果到表格，並生成航班號按鈕
        function filterFlights(airlineCode) {
            currentFilteredFlights = flightData.filter(flight => flight.ACode === airlineCode);

            if (currentFilteredFlights.length === 0) {
                document.getElementById("output").innerText = translations[currentLanguage]["noFlights"];
                document.getElementById("flightButtons").innerHTML = ""; // 清空航班號按鈕
            } else {
                generateFlightNumberButtons(currentFilteredFlights);  // 生成航班號按鈕
                displayFlights(currentFilteredFlights, airlineCode);  // 傳遞 airlineCode 作為 ACode 參數
            }
        }


        // 根據具體的 FlightNo 生成航班號按鈕
        function generateFlightNumberButtons(flights) {
            let flightButtonContent = "";

            flights.forEach(flight => {
                let btnClass = flight.ACode === 'BR' ? 'btn-br' : 'btn-ci';
                flightButtonContent += `<a href="javascript:void(0);" class="btn ${btnClass} btn-no-hover m-1" onclick="filterFlightByNumber('${flight.FlightNo}', '${flight.ACode}')">${flight.FlightNo}</a>`;
            });

            document.getElementById("flightButtons").innerHTML = flightButtonContent;
        }



        // 根據具體的 FlightNo 過濾航班
        function filterFlightByNumber(flightNumber, ACode) {
            const filteredFlight = currentFilteredFlights.filter(flight => flight.FlightNo === flightNumber);
            displayFlights(filteredFlight, ACode); // 傳遞 ACode 參數以確保背景顏色正確應用
        }

        // 顯示航班資料到表格，並在航班號前加上 logo
        function displayFlights(flights, ACode) {
            // 確定表格頭部的樣式類根據傳遞進來的 ACode
            let airlineClass = 'table-light';  // 預設為 table-light
            if (ACode === 'BR') {
                airlineClass = 'table-br';
            } else if (ACode === 'CI') {
                airlineClass = 'table-ci';
            }

            // 直接在 thead 中添加相应的 class
            let tableContent = `
            <table class="table table-sm table-striped table-borderless">
                <thead class="${airlineClass}">
                    <tr>
                        <th>${translations[currentLanguage]["tableHeaders"]["FlightNumber"]}</th>
                        <th>${translations[currentLanguage]["tableHeaders"]["Departure"]}</th>
                        <th>${translations[currentLanguage]["tableHeaders"]["Terminal"]}</th>
                        <th>${translations[currentLanguage]["tableHeaders"]["Gate"]}</th>
                        <th>${translations[currentLanguage]["tableHeaders"]["Carousel"]}</th>
                    </tr>
                </thead>
                <tbody>`;

            flights.forEach(flight => {
                const cityDisplay = currentLanguage === 'zh' 
                    ? `${flight.CityName}`
                    : `${flight.CityEname}`;

                const terminalDisplay = flight.BNO ? `T${flight.BNO}` : '';
                const logoUrl = `https://www.taoyuan-airport.com/uploads/airlogo/${flight.ACode}.gif`;

                tableContent += `
                    <tr>
                        <td>
                            <img alt="" width="28" height="20" src="${logoUrl}">
                            ${flight.ACode}${flight.FlightNo}
                        </td>
                        <td>${cityDisplay}</td>
                        <td>${terminalDisplay}</td>
                        <td>${flight.Gate}</td>
                        <td>${flight.StopCode}</td>
                    </tr>`;
            });

            tableContent += `</tbody></table>`;

            // 將表格內容插入到 output 區域
            document.getElementById("output").innerHTML = tableContent;
        }

        // 頁面加載時，檢測語言並載入資料
        window.onload = function() {
            detectLanguage();  // 自動檢測語言並初始化
        };
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
