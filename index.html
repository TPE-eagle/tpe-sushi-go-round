<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taipei Carousel</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            margin: 20px;
        }
        a {
            margin-right: 10px;
            font-size: 14px;
        }
        #flightButtons a {
            margin-right: 5px;
        }
        
        #footer {
            margin-top: 40px;
            text-align: center;
        }
        #footer img {
            margin-right: 10px;
            vertical-align: middle;
        }
        .lang-switch a {
            text-decoration: none;
            margin: 0 10px;
            font-size: 16px;
            color: inherit;
        }
        .no-color-link a {
            color: inherit;
            text-decoration: underline;
        }
        .footer-container {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            gap: 5px; /* 控制元素之間的間距 */
        }
        .footer-text {
            margin: 0;
            line-height: 1.2; /* 減少行距 */
        }

        /* BR (EVA Airways) Outline Button 樣式 */
        .btn-outline-br {
            border-color: #4b7d6b;
            color: #4b7d6b;
        }

        .btn-outline-br:hover, .btn-outline-br.active {
            background-color: #4b7d6b !important;
            color: white !important;
            border-color: #4b7d6b;
        }

        /* CI (China Airlines) Outline Button 樣式 */
        .btn-outline-ci {
            border-color: #3e62ad;
            color: #3e62ad;
        }

        .btn-outline-ci:hover, .btn-outline-ci.active {
            background-color: #3e62ad !important;
            color: white !important;
            border-color: #3e62ad;
        }

        /* JX (Starlux Airlines) Outline Button 樣式 */
        .btn-outline-jx {
            border-color: #4e463f;
            color: #4e463f;
        }

        .btn-outline-jx:hover, .btn-outline-jx.active {
            background-color: #4e463f !important;
            color: white !important;
            border-color: #4e463f;
        }

        /* BR (EVA Airways) 表格標題樣式 */
        .table-br {
            --bs-table-bg: #4b7d6b;  /* 定義背景色 */
            --bs-table-color: white;  /* 定義文字顏色 */
        }

        /* CI (China Airlines) 表格標題樣式 */
        .table-ci {
            --bs-table-bg: #3e62ad;  /* 定義背景色 */
            --bs-table-color: white;  /* 定義文字顏色 */
        }

        /* JX (Starlux Airlines) 表格標題樣式 */
        .table-jx {
            --bs-table-bg: #4e463f;  /* 定義背景色 */
            --bs-table-color: white;  /* 定義文字顏色 */
        }

        /* 寬螢幕顯示 */
        .airline-full {
            display: inline; /* 顯示完整名稱 */
        }

        .airline-short {
            display: none; /* 隱藏縮寫 */
        }

        /* 小螢幕顯示 */
        @media (max-width: 768px) {
            .airline-full {
                display: none; /* 隱藏完整名稱 */
            }
            .airline-short {
                display: inline; /* 顯示縮寫 */
            }
        }

        /* 美化航空公司按鈕 */
        .airline-link {
            display: inline-flex;
            align-items: center;
            margin-right: 10px;
            font-size: 14px;
            color: inherit;
        }

    </style>
</head>
<body>

    <div class="container">
        <h1 id="title" class="text-center my-4"></h1>

        <!-- 動態生成的航空公司按鈕 -->
        <div id="airlineButtons" class="d-flex justify-content-center flex-wrap mb-3"></div>

        <!-- 動態生成的航班號按鈕區域 -->
        <div id="flightButtons" class="d-flex justify-content-center flex-wrap"></div>

        <!-- 結果輸出 -->
        <div id="output"></div>

        <!-- 語言切換按鈕放到頁面底部 -->
        <div id="footer">
            <div class="lang-switch no-color-link text-muted d-flex justify-content-center mb-2">
                <a href="javascript:void(0);" onclick="changeLanguage('zh')">🇹🇼 繁體中文</a> |
                <a href="javascript:void(0);" onclick="changeLanguage('en')">🇬🇧 English</a> |
                <a href="javascript:void(0);" onclick="changeLanguage('jp')">🇯🇵 日本語</a>
            </div>

            <!-- 註解部分 -->
            <div class="footer-container">
                <div class="no-color-link footer-text text-muted">
                    Data source: <a href="https://www.taoyuan-airport.com/flight_arrival">Taoyuan International Airport</a>
                </div>
                <!-- 顯示 API query parameter 的日期和時間範圍 -->
                <div id="apiParams" class="footer-text text-muted"></div>
                <div class="footer-text">
                    Made by EVA Pilot with <span style="color: red;">❤️</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let flightData = [];  // 存儲所有撈取的航班資料
        let currentFilteredFlights = [];  // 存儲當前過濾的航空公司航班
        let currentLanguage = 'zh';  // 預設語言為繁體中文

        // 定義翻譯字典
        const translations = {
            "zh": {
                "title": "台北迴轉壽司🍣",
                "noFlights": "沒有找到符合條件的航班。",
                "noTimeRange": "無法匹配時間範圍",
                "querySuccess": "請點擊上方按鈕以查看航班資料。",
                "error": "查詢失敗，請稍後再試。",
                "tableHeaders": {
                    "FlightNumber": "航班號",
                    "FlightNumberShort": "航班",
                    "Departure": "出發地",
                    "Terminal": "航廈",
                    "TerminalShort": "航廈",
                    "Gate": "登機門",
                    "Carousel": "行李轉盤",
                    "CarouselShort": "轉盤"
                }
            },
            "en": {
                "title": "Taipei sushi-go-round🍣",
                "noFlights": "No matching flights found.",
                "noTimeRange": "Cannot match the time range",
                "querySuccess": "Please click the buttons above to view flight data.",
                "error": "Query failed, please try again later.",
                "tableHeaders": {
                    "FlightNumber": "Flight Number",
                    "FlightNumberShort": "Flt. No",
                    "Departure": "Departure",
                    "Terminal": "Terminal",
                    "TerminalShort": "Term.",
                    "Gate": "Gate",
                    "Carousel": "Carousel",
                    "CarouselShort": "Carousel"
                }
            },
            "jp": {
                "title": "台北回転寿司🍣",
                "noFlights": "一致するフライトが見つかりません。",
                "noTimeRange": "時間範囲が一致しません。",
                "querySuccess": "上記のボタンをクリックしてフライトデータを表示してください。",
                "error": "クエリに失敗しました。後でもう一度やり直してください。",
                "tableHeaders": {
                    "FlightNumber": "フライト番号",
                    "FlightNumberShort": "番号",
                    "Departure": "出発地",
                    "Terminal": "ターミナル",
                    "TerminalShort": "ターミナル",
                    "Gate": "ゲート",
                    "Carousel": "荷物回転台",
                    "CarouselShort": "回転台"
                }
            }
        };

        // 更新頁面上的文字
        function updateLanguageText() {
            document.getElementById("title").innerText = translations[currentLanguage]["title"];
        }

        // 自動檢測使用者瀏覽器語言
        function detectLanguage() {
            const browserLang = navigator.language || navigator.userLanguage;
            if (browserLang.startsWith("zh")) {
                currentLanguage = 'zh';  // 設置為中文
            } else if (browserLang.startsWith("ja")) {
                currentLanguage = 'jp';  // 設置為日文
            } else {
                currentLanguage = 'en';  // 設置為英文
            }
            updateLanguageText();  // 更新頁面文字
            fetchData(); // 根據檢測到的語言重新載入資料
            updateApiParams(); // 更新 API query parameters 顯示
        }

        // 切換語言
        function changeLanguage(lang) {
            currentLanguage = lang;
            updateLanguageText();  // 更新頁面文字
            fetchData();  // 重新發送請求
            updateApiParams();  // 更新 API query parameters 顯示
            // 清空 flightButtons 區域
            document.getElementById("flightButtons").innerHTML = ""; 
        }

        // Helper: 取得當前的 UTC+8 日期，格式為 "YYYY/MM/DD"
        function getUTC8Date() {
            const nowUTC = new Date(new Date().toISOString());
            const utc8Time = new Date(nowUTC.getTime() + 8 * 60 * 60 * 1000); // 轉換為 UTC+8
            return utc8Time.toISOString().split('T')[0].replace(/-/g, '/'); // 將日期中的 "-" 替換為 "/"
        }

        // Helper: 取得當前 UTC+8 時間範圍
        function getCurrentTimeRangeInUTC8() {
            const nowUTC = new Date(new Date().toISOString()); 
            const utc8Time = new Date(nowUTC.getTime() + 8 * 60 * 60 * 1000); 
            const hours = utc8Time.getUTCHours();

            const timeRanges = [
                { start: "00:00", end: "01:59" },
                { start: "02:00", end: "05:59" },
                { start: "06:00", end: "07:59" },
                { start: "08:00", end: "09:59" },
                { start: "10:00", end: "11:59" },
                { start: "12:00", end: "13:59" },
                { start: "14:00", end: "15:59" },
                { start: "16:00", end: "17:59" },
                { start: "18:00", end: "19:59" },
                { start: "20:00", end: "21:59" },
                { start: "22:00", end: "23:59" }
            ];

            for (const range of timeRanges) {
                const [startHours] = range.start.split(":").map(Number);
                const [endHours] = range.end.split(":").map(Number);

                if (hours >= startHours && hours <= endHours) {
                    return range;
                }
            }
            return null;
        }

        // 更新 API query parameters 顯示
        function updateApiParams() {
            const date = getUTC8Date();
            const timeRange = getCurrentTimeRangeInUTC8();
            if (timeRange) {
                const apiParamsText = `Query date: ${date}, Time range: ${timeRange.start} - ${timeRange.end}`;
                document.getElementById("apiParams").innerText = apiParamsText;
            } else {
                document.getElementById("apiParams").innerText = "No time range available";
            }
        }

        // Fetch API 資料
        function fetchData() {
            const currentRange = getCurrentTimeRangeInUTC8();

            if (currentRange) {
                const postData = {
                    "ODate": getUTC8Date(), // 當前 UTC+8 日期，格式為 "YYYY/MM/DD"
                    "OTimeOpen": currentRange.start,
                    "OTimeClose": currentRange.end,
                    "BNO": null,
                    "AState": "A",
                    "language": currentLanguage === "zh" ? "ch" : currentLanguage, // 根據語言切換 API 查詢語言
                    "keyword": "" // 可選關鍵字，這裡已經去掉輸入框，所以保留空字串
                };

                // 使用 Fetch 發送請求
                fetch("https://www.taoyuan-airport.com/api/api/flight/a_flight", {
                    body: JSON.stringify(postData),
                    cache: "default",
                    headers: {
                        "Accept": "application/json, text/plain, */*",
                        "Accept-Language": "en-US,en;q=0.9",
                        "Content-Type": "application/json",
                        // "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.6 Safari/605.1.15"
                    },
                    method: "POST",
                    mode: "cors",
                    redirect: "follow",
                    referrerPolicy: "strict-origin-when-cross-origin"
                })
                .then(response => response.json())
                .then(data => {
                    flightData = data.filter(flight => flight.ACode === 'BR' || flight.ACode === 'CI' || flight.ACode === 'JX');  // 預設顯示 BR, CI 和 JX 的航班
                    generateAirlineLinks(flightData); // 動態生成航空公司按鈕
                    displayFlights(flightData); // 預設顯示全部 BR, CI 和 JX 的航班
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById("output").innerText = translations[currentLanguage]["error"];
                });
            } else {
                document.getElementById("output").innerText = translations[currentLanguage]["noTimeRange"];
            }
        }

        function generateAirlineLinks(flights) {
            let airlines = {};

            // 遍历航班数据，收集航空公司信息
            flights.forEach(flight => {
                if (!airlines[flight.ACode]) {
                    airlines[flight.ACode] = flight.AName + ` (${flight.ACode})`;
                }
            });

            let linksHTML = '';

            // 只处理 BR, CI, JX
            const airlineCodes = ['BR', 'CI', 'JX'];

            // 按顺序生成航空公司按钮，只显示 BR, CI, JX
            airlineCodes.forEach(code => {
                if (airlines[code]) {
                    const logoUrl = `https://www.taoyuan-airport.com/uploads/airlogo/${code}.gif`;
                    linksHTML += `
                        <a href="javascript:void(0);" onclick="filterFlights('${code}')" class="airline-link">
                            <img alt="${code} Logo" width="28" height="20" src="${logoUrl}">
                            <span class="airline-full">${airlines[code]}</span>
                            <span class="airline-short">${code}</span>
                        </a>`;
                }
            });

            document.getElementById('airlineButtons').innerHTML = linksHTML;
        }

        // 根據 ACode 過濾航班資料並顯示結果到表格，並生成航班號按鈕
        function filterFlights(airlineCode) {
            currentFilteredFlights = flightData.filter(flight => flight.ACode === airlineCode);

            if (currentFilteredFlights.length === 0) {
                document.getElementById("output").innerText = translations[currentLanguage]["noFlights"];
                document.getElementById("flightButtons").innerHTML = ""; // 清空航班號按鈕
            } else {
                generateFlightNumberButtons(currentFilteredFlights);  // 生成航班號按鈕
                displayFlights(currentFilteredFlights, airlineCode);  // 傳遞 airlineCode 作為 ACode 參數
            }
        }

        // 根據具體的 FlightNo 生成航班號按鈕
        function generateFlightNumberButtons(flights) {
            let flightButtonContent = "";

            flights.forEach(flight => {
                let btnClass = flight.ACode === 'BR' ? 'btn-outline-br' :
                            flight.ACode === 'CI' ? 'btn-outline-ci' :
                            'btn-outline-jx';  // 为 JX 设置按钮样式
                flightButtonContent += `<a href="javascript:void(0);" class="btn ${btnClass} btn-no-hover m-1" onclick="filterFlightByNumber('${flight.FlightNo}', '${flight.ACode}')">${flight.FlightNo}</a>`;
            });

            document.getElementById("flightButtons").innerHTML = flightButtonContent;
        }



        // 根據具體的 FlightNo 過濾航班
        function filterFlightByNumber(flightNumber, ACode) {
            // 清除所有航班按鈕的 active 狀態
            document.querySelectorAll("#flightButtons a").forEach(button => {
                button.classList.remove('active');
            });

            // 將當前點擊的按鈕設置為 active
            const activeButton = document.querySelector(`a[onclick="filterFlightByNumber('${flightNumber}', '${ACode}')"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }

            // 根據選擇的航班號顯示過濾後的表格
            const filteredFlight = currentFilteredFlights.filter(flight => flight.FlightNo === flightNumber);
            displayFlights(filteredFlight, ACode);
        }

        // 声明全局变量，保存当前的 ACode 和当前语言
        let currentACode = null;

        // 判断是否为小屏幕
        function isSmallScreen() {
            return window.innerWidth <= 768;
        }

        // 根据屏幕大小更新表头并显示表格
        function displayFlights(flights, ACode) {
            currentACode = ACode;  // 保存当前 ACode

            // 判断当前屏幕大小以决定表头显示
            const flightNumberHeader = isSmallScreen()
                ? translations[currentLanguage]["tableHeaders"]["FlightNumberShort"]
                : translations[currentLanguage]["tableHeaders"]["FlightNumber"];

            const terminalHeader = isSmallScreen()
                ? translations[currentLanguage]["tableHeaders"]["TerminalShort"]
                : translations[currentLanguage]["tableHeaders"]["Terminal"];

            const carouselHeader = isSmallScreen()
                ? translations[currentLanguage]["tableHeaders"]["CarouselShort"]
                : translations[currentLanguage]["tableHeaders"]["Carousel"];

            let airlineClass = 'table-dark';  // 默认 table-dark
            if (ACode === 'BR') {
                airlineClass = 'table-br';
            } else if (ACode === 'CI') {
                airlineClass = 'table-ci';
            } else if (ACode === 'JX') {
                airlineClass = 'table-jx';  // JX 表格样式
            }

            let tableContent = `
            <table class="table table-sm table-striped table-borderless">
                <thead class="${airlineClass}">
                    <tr>
                        <th>${flightNumberHeader}</th>
                        <th>${translations[currentLanguage]["tableHeaders"]["Departure"]}</th>
                        <th>${terminalHeader}</th>
                        <th>${translations[currentLanguage]["tableHeaders"]["Gate"]}</th>
                        <th>${carouselHeader}</th>
                    </tr>
                </thead>
                <tbody>`;

            flights.forEach(flight => {
                const cityDisplay = currentLanguage === 'zh' ? flight.CityName : flight.CityEname;
                const terminalDisplay = flight.BNO ? `T${flight.BNO}` : '';
                const logoUrl = `https://www.taoyuan-airport.com/uploads/airlogo/${flight.ACode}.gif`;

                tableContent += `
                    <tr>
                        <td>
                            <img alt="" width="28" height="20" src="${logoUrl}">
                            ${flight.ACode}${flight.FlightNo}
                        </td>
                        <td>${cityDisplay}</td>
                        <td>${terminalDisplay}</td>
                        <td>${flight.Gate}</td>
                        <td>${flight.StopCode}</td>
                    </tr>`;
            });

            tableContent += `</tbody></table>`;

            document.getElementById("output").innerHTML = tableContent;
        }

        // 监听窗口大小变化并重新渲染表格
        window.addEventListener('resize', function() {
            if (currentFilteredFlights.length > 0 && currentACode) {
                displayFlights(currentFilteredFlights, currentACode); // 使用保存的ACode重新渲染
            }
        });

        // Safari 支持的 orientationchange 事件
        window.addEventListener('orientationchange', function() {
            if (currentFilteredFlights.length > 0 && currentACode) {
                displayFlights(currentFilteredFlights, currentACode); // 使用保存的ACode重新渲染
            }
        });

        // 页面加载时自动检测语言并加载航班数据
        window.onload = function() {
            detectLanguage();  // 自动检测语言并初始化
        };
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
